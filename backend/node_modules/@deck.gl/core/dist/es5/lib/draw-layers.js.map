{"version":3,"sources":["../../../src/lib/draw-layers.js"],"names":["LOG_PRIORITY_DRAW","renderCount","getPixelRatio","useDevicePixels","window","devicePixelRatio","getGLViewport","gl","viewport","pixelRatio","height","canvas","clientHeight","dimensions","x","y","width","clearCanvas","drawingBufferWidth","drawingBufferHeight","clear","GL","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","drawLayers","layers","viewports","views","onViewportActive","drawPickingColors","deviceRect","parameters","layerFilter","pass","redrawReason","stats","forEach","viewportOrDescriptor","i","getViewportFromDescriptor","view","id","drawLayersInViewport","drawPickingBuffer","pickingFBO","framebuffer","scissorTest","scissor","clearColor","blend","blendFunc","ONE","ZERO","CONSTANT_ALPHA","blendEquation","FUNC_ADD","blendColor","glViewport","props","clearOpts","color","depth","renderStats","totalCount","length","visibleCount","compositeCount","pickableCount","layer","layerIndex","shouldDrawLayer","isComposite","visible","pickable","isPicking","drawLayerInViewport","logRenderStats","moduleParameters","Object","assign","create","context","pickingActive","uniforms","layerParameters","getObjectHighlightParameters","drawLayer","log","priority","primitiveCount","hiddenCount","message","increment","highlightedObjectIndex","highlightColor","pickingHighlightColor","Number","isInteger","pickingSelectedColor","encodePickingColor"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global window */\nimport GL from 'luma.gl/constants';\nimport {withParameters, setParameters, clear} from 'luma.gl';\nimport log from '../utils/log';\nimport assert from '../utils/assert';\n\nconst LOG_PRIORITY_DRAW = 2;\n\nlet renderCount = 0;\n\n// TODO - Exported for pick-layers.js - Move to util?\nexport const getPixelRatio = ({useDevicePixels}) => {\n  assert(typeof useDevicePixels === 'boolean', 'Invalid useDevicePixels');\n  return useDevicePixels && typeof window !== 'undefined' ? window.devicePixelRatio : 1;\n};\n\n// Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\nconst getGLViewport = (gl, {viewport, pixelRatio}) => {\n  // TODO - dummy default for node\n  const height = gl.canvas ? gl.canvas.clientHeight : 100;\n  // Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\n  const dimensions = viewport;\n  return [\n    dimensions.x * pixelRatio,\n    (height - dimensions.y - dimensions.height) * pixelRatio,\n    dimensions.width * pixelRatio,\n    dimensions.height * pixelRatio\n  ];\n};\n\n// Helper functions\n\nfunction clearCanvas(gl, {useDevicePixels}) {\n  // const pixelRatio = getPixelRatio({useDevicePixels});\n  const width = gl.drawingBufferWidth;\n  const height = gl.drawingBufferHeight;\n  // clear depth and color buffers, restoring transparency\n  withParameters(gl, {viewport: [0, 0, width, height]}, () => {\n    gl.clear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);\n  });\n}\n\n// Draw a list of layers in a list of viewports\nexport function drawLayers(\n  gl,\n  {\n    layers,\n    viewports,\n    views,\n    onViewportActive,\n    useDevicePixels,\n    drawPickingColors = false,\n    deviceRect = null,\n    parameters = {},\n    layerFilter = null,\n    pass = 'draw',\n    redrawReason = '',\n    stats\n  }\n) {\n  clearCanvas(gl, {useDevicePixels});\n\n  // effectManager.preDraw();\n\n  viewports.forEach((viewportOrDescriptor, i) => {\n    const viewport = getViewportFromDescriptor(viewportOrDescriptor);\n    const view = views && views[viewport.id];\n\n    // Update context to point to this viewport\n    onViewportActive(viewport);\n\n    // render this viewport\n    drawLayersInViewport(gl, {\n      layers,\n      viewport,\n      view,\n      useDevicePixels,\n      drawPickingColors,\n      deviceRect,\n      parameters,\n      layerFilter,\n      pass,\n      redrawReason,\n      stats\n    });\n  });\n\n  // effectManager.draw();\n}\n\n// Draws list of layers and viewports into the picking buffer\n// Note: does not sample the buffer, that has to be done by the caller\nexport function drawPickingBuffer(\n  gl,\n  {\n    layers,\n    viewports,\n    onViewportActive,\n    useDevicePixels,\n    pickingFBO,\n    deviceRect: {x, y, width, height},\n    layerFilter = null,\n    redrawReason = ''\n  }\n) {\n  // Make sure we clear scissor test and fbo bindings in case of exceptions\n  // We are only interested in one pixel, no need to render anything else\n  // Note that the callback here is called synchronously.\n  // Set blend mode for picking\n  // always overwrite existing pixel with [r,g,b,layerIndex]\n  return withParameters(\n    gl,\n    {\n      framebuffer: pickingFBO,\n      scissorTest: true,\n      scissor: [x, y, width, height],\n      clearColor: [0, 0, 0, 0]\n    },\n    () => {\n      drawLayers(gl, {\n        layers,\n        viewports,\n        onViewportActive,\n        useDevicePixels,\n        drawPickingColors: true,\n        layerFilter,\n        pass: 'picking',\n        redrawReason,\n        parameters: {\n          blend: true,\n          blendFunc: [gl.ONE, gl.ZERO, gl.CONSTANT_ALPHA, gl.ZERO],\n          blendEquation: gl.FUNC_ADD,\n          blendColor: [0, 0, 0, 0]\n        }\n      });\n    }\n  );\n}\n\n// Draws a list of layers in one viewport\n// TODO - when picking we could completely skip rendering viewports that dont\n// intersect with the picking rect\nfunction drawLayersInViewport(\n  gl,\n  {\n    layers,\n    viewport,\n    view,\n    useDevicePixels,\n    drawPickingColors = false,\n    deviceRect = null,\n    parameters = {},\n    layerFilter,\n    pass = 'draw',\n    redrawReason = '',\n    stats\n  }\n) {\n  const pixelRatio = getPixelRatio({useDevicePixels});\n  const glViewport = getGLViewport(gl, {viewport, pixelRatio});\n\n  if (view && view.props.clear) {\n    const clearOpts = view.props.clear === true ? {color: true, depth: true} : view.props.clear;\n    withParameters(\n      gl,\n      {\n        scissorTest: true,\n        scissor: glViewport\n      },\n      () => clear(gl, clearOpts)\n    );\n  }\n\n  // render layers in normal colors\n  const renderStats = {\n    totalCount: layers.length,\n    visibleCount: 0,\n    compositeCount: 0,\n    pickableCount: 0\n  };\n\n  // const {x, y, width, height} = deviceRect || [];\n\n  setParameters(gl, parameters || {});\n\n  // render layers in normal colors\n  layers.forEach((layer, layerIndex) => {\n    // Check if we should draw layer\n    let shouldDrawLayer = !layer.isComposite && layer.props.visible;\n    if (drawPickingColors) {\n      shouldDrawLayer = shouldDrawLayer && layer.props.pickable;\n    }\n    if (shouldDrawLayer && layerFilter) {\n      shouldDrawLayer = layerFilter({layer, viewport, isPicking: drawPickingColors});\n    }\n\n    // Calculate stats\n    if (shouldDrawLayer && layer.props.pickable) {\n      renderStats.pickableCount++;\n    }\n    if (layer.isComposite) {\n      renderStats.compositeCount++;\n    }\n\n    // Draw the layer\n    if (shouldDrawLayer) {\n      renderStats.visibleCount++;\n\n      drawLayerInViewport({\n        gl,\n        layer,\n        layerIndex,\n        drawPickingColors,\n        pixelRatio,\n        glViewport,\n        parameters\n      });\n    }\n  });\n\n  renderCount++;\n\n  logRenderStats({renderStats, pass, redrawReason, stats});\n}\n\nfunction drawLayerInViewport({\n  gl,\n  layer,\n  layerIndex,\n  drawPickingColors,\n  pixelRatio,\n  glViewport,\n  parameters\n}) {\n  const moduleParameters = Object.assign(Object.create(layer.props), {\n    viewport: layer.context.viewport,\n    pickingActive: drawPickingColors ? 1 : 0,\n    devicePixelRatio: pixelRatio\n  });\n\n  const uniforms = Object.assign({}, layer.context.uniforms, {layerIndex});\n\n  // All parameter resolving is done here instead of the layer\n  // Blend parameters must not be overriden\n  const layerParameters = Object.assign({}, layer.props.parameters || {}, parameters);\n\n  Object.assign(layerParameters, {\n    viewport: glViewport\n  });\n\n  if (drawPickingColors) {\n    Object.assign(layerParameters, {\n      blendColor: [0, 0, 0, (layerIndex + 1) / 255]\n    });\n  } else {\n    Object.assign(moduleParameters, getObjectHighlightParameters(layer));\n  }\n\n  layer.drawLayer({\n    moduleParameters,\n    uniforms,\n    parameters: layerParameters\n  });\n}\n\nfunction logRenderStats({renderStats, pass, redrawReason, stats}) {\n  if (log.priority >= LOG_PRIORITY_DRAW) {\n    const {totalCount, visibleCount, compositeCount, pickableCount} = renderStats;\n    const primitiveCount = totalCount - compositeCount;\n    const hiddenCount = primitiveCount - visibleCount;\n\n    let message = '';\n    message += `RENDER #${renderCount} \\\n${visibleCount} (of ${totalCount} layers) to ${pass} because ${redrawReason} `;\n    if (log.priority > LOG_PRIORITY_DRAW) {\n      message += `\\\n(${hiddenCount} hidden, ${compositeCount} composite ${pickableCount} pickable)`;\n    }\n\n    log.log(LOG_PRIORITY_DRAW, message)();\n\n    if (stats) {\n      stats.increment('redraw layers', visibleCount);\n    }\n  }\n}\n\n// Get a viewport from a viewport descriptor (which can be a plain viewport)\nfunction getViewportFromDescriptor(viewportOrDescriptor) {\n  return viewportOrDescriptor.viewport ? viewportOrDescriptor.viewport : viewportOrDescriptor;\n}\n\n/**\n * Returns the picking color of currenlty selected object of the given 'layer'.\n * @return {Array} - the picking color or null if layers selected object is invalid.\n */\nfunction getObjectHighlightParameters(layer) {\n  // TODO - inefficient to update settings every render?\n  // TODO: Add warning if 'highlightedObjectIndex' is > numberOfInstances of the model.\n  const {highlightedObjectIndex, highlightColor} = layer.props;\n  const parameters = {\n    pickingHighlightColor: highlightColor\n  };\n\n  // Update picking module settings if highlightedObjectIndex is set.\n  // This will overwrite any settings from auto highlighting.\n  if (Number.isInteger(highlightedObjectIndex)) {\n    parameters.pickingSelectedColor =\n      highlightedObjectIndex >= 0 ? layer.encodePickingColor(highlightedObjectIndex) : null;\n  }\n  return parameters;\n}\n"],"file":"draw-layers.js"}