{"version":3,"sources":["../../../../src/shaderlib/lighting/lighting.js"],"names":["lightingShader","project","COORDINATE_SYSTEM","projectPosition","PROJECT_COORDINATE_SYSTEM","memoize","name","dependencies","vs","getUniforms","deprecations","type","old","new","deprecated","INITIAL_MODULE_OPTIONS","DEFAULT_LIGHTS_POSITION","DEFAULT_LIGHTS_STRENGTH","DEFAULT_AMBIENT_RATIO","DEFAULT_DIFFUSE_RATIO","DEFAULT_SPECULAR_RATIO","DEFAULT_COORDINATE_ORIGIN","getMemoizedLightPositions","preprojectLightPositions","opts","context","lightSettings","numberOfLights","lightsPosition","lightsStrength","coordinateSystem","fromCoordinateSystem","LNGLAT","coordinateOrigin","fromCoordinateOrigin","modelMatrix","ambientRatio","diffuseRatio","specularRatio","project_uCoordinateSystem","LNGLAT_AUTO_OFFSET","LNGLAT_OFFSETS","project_coordinate_origin","lightsPositionWorld","viewport","lighting_lightPositions","lighting_lightStrengths","lighting_ambientRatio","lighting_diffuseRatio","lighting_specularRatio","lighting_numberOfLights","projectionParameters","i","position","slice"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport lightingShader from './lighting.glsl';\nimport project from '../project/project';\nimport {COORDINATE_SYSTEM} from '../../lib/constants';\nimport {projectPosition} from '../project/project-functions';\nimport {PROJECT_COORDINATE_SYSTEM} from '../project/constants';\nimport memoize from '../../utils/memoize';\n\nexport default {\n  name: 'lighting',\n  dependencies: [project],\n  vs: lightingShader,\n  getUniforms,\n  deprecations: [\n    // Deprecated lighting functions\n    {type: 'function', old: 'getLightWeight', new: 'lighting_getLightWeight', deprecated: true}\n  ]\n};\n\nconst INITIAL_MODULE_OPTIONS = {};\n\nconst DEFAULT_LIGHTS_POSITION = [-122.45, 37.75, 8000];\nconst DEFAULT_LIGHTS_STRENGTH = [2.0, 0.0];\nconst DEFAULT_AMBIENT_RATIO = 0.4;\nconst DEFAULT_DIFFUSE_RATIO = 0.6;\nconst DEFAULT_SPECULAR_RATIO = 0.8;\nconst DEFAULT_COORDINATE_ORIGIN = [0, 0, 0];\n\nconst getMemoizedLightPositions = memoize(preprojectLightPositions);\n\n// TODO: support partial update, e.g.\n// `lightedModel.setModuleParameters({diffuseRatio: 0.3});`\nfunction getUniforms(opts = INITIAL_MODULE_OPTIONS, context = {}) {\n  if (!opts.lightSettings) {\n    return {};\n  }\n\n  const {\n    numberOfLights = 1,\n\n    lightsPosition = DEFAULT_LIGHTS_POSITION,\n    lightsStrength = DEFAULT_LIGHTS_STRENGTH,\n    coordinateSystem: fromCoordinateSystem = COORDINATE_SYSTEM.LNGLAT,\n    coordinateOrigin: fromCoordinateOrigin = DEFAULT_COORDINATE_ORIGIN,\n    modelMatrix = null,\n\n    ambientRatio = DEFAULT_AMBIENT_RATIO,\n    diffuseRatio = DEFAULT_DIFFUSE_RATIO,\n    specularRatio = DEFAULT_SPECULAR_RATIO\n  } = opts.lightSettings;\n\n  let coordinateSystem = opts.coordinateSystem;\n  let coordinateOrigin = opts.coordinateOrigin;\n\n  if (context.project_uCoordinateSystem === PROJECT_COORDINATE_SYSTEM.LNGLAT_AUTO_OFFSET) {\n    coordinateSystem = COORDINATE_SYSTEM.LNGLAT_OFFSETS;\n    coordinateOrigin = context.project_coordinate_origin;\n  }\n\n  // Pre-project light positions\n  const lightsPositionWorld = getMemoizedLightPositions({\n    lightsPosition,\n    numberOfLights,\n    viewport: opts.viewport,\n    modelMatrix,\n    coordinateSystem,\n    coordinateOrigin,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  });\n\n  return {\n    lighting_lightPositions: lightsPositionWorld,\n    lighting_lightStrengths: lightsStrength,\n    lighting_ambientRatio: ambientRatio,\n    lighting_diffuseRatio: diffuseRatio,\n    lighting_specularRatio: specularRatio,\n    lighting_numberOfLights: numberOfLights\n  };\n}\n\n// Pre-project light positions\nfunction preprojectLightPositions({\n  lightsPosition,\n  numberOfLights,\n  viewport,\n  modelMatrix,\n  coordinateSystem,\n  coordinateOrigin,\n  fromCoordinateSystem,\n  fromCoordinateOrigin\n}) {\n  const projectionParameters = {\n    viewport,\n    modelMatrix,\n    coordinateSystem,\n    coordinateOrigin,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  };\n\n  const lightsPositionWorld = [];\n  for (let i = 0; i < numberOfLights; i++) {\n    const position = projectPosition(lightsPosition.slice(i * 3, i * 3 + 3), projectionParameters);\n\n    lightsPositionWorld[i * 3] = position[0];\n    lightsPositionWorld[i * 3 + 1] = position[1];\n    lightsPositionWorld[i * 3 + 2] = position[2];\n  }\n\n  return lightsPositionWorld;\n}\n"],"file":"lighting.js"}