{"version":3,"sources":["../../../../src/test-utils/browser-automation/browser-driver.js"],"names":["log","Log","id","DEFAULT_CONFIG","process","parameters","port","options","maxBuffer","DEFAULT_PUPPETEER_OPTIONS","headless","BrowserDriver","execFile","module","require","puppeteer","console","child","browser","page","shellStatus","success","Promise","resolve","launch","then","url","width","height","message","color","COLOR","YELLOW","startBrowser","_","newPage","waitFor","goto","setViewport","name","exposeFunction","close","config","maxRetryTimes","newConfig","Object","assign","reject","timeout","setTimeout","error","clearTimeout","catch","startServer","RED","kill","exit","stopBrowser","stopServer","exitProcess"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {COLOR} from '../../lib/utils/color';\nimport Log from '../../lib/log';\nconst log = new Log({id: 'render-test'});\n\nconst DEFAULT_CONFIG = {\n  process: './node_modules/.bin/webpack-dev-server',\n  parameters: ['--config', 'webpack.config.js'],\n  port: 5000,\n  options: {maxBuffer: 5000 * 1024}\n};\n\nconst DEFAULT_PUPPETEER_OPTIONS = {\n  headless: false\n};\n\nexport default class BrowserDriver {\n  constructor() {\n    this.execFile = module.require('child_process').execFile;\n    this.puppeteer = module.require('puppeteer');\n    this.console = module.require('console');\n    this.process = module.require('process');\n\n    this.child = null;\n    this.browser = null;\n    this.page = null;\n    this.port = null;\n    this.shellStatus = 0;\n  }\n\n  setShellStatus(success) {\n    // return value that is visible to the shell, 0 is success\n    this.shellStatus = success ? 0 : 1;\n  }\n\n  startBrowser(options = DEFAULT_PUPPETEER_OPTIONS) {\n    if (this.browser) {\n      return Promise.resolve(this.browser);\n    }\n    return this.puppeteer\n      .launch(options)\n      .then(browser => {\n        this.browser = browser;\n      });\n  }\n\n  newPage({url = 'http://localhost', width = 1550, height = 850} = {}) {\n    log.log({\n      message: `Connecting to port: ${this.port}`,\n      color: COLOR.YELLOW\n    })();\n    return this.startBrowser()\n      .then(_ => this.browser.newPage())\n      .then(page => {\n        this.page = page;\n      })\n      .then(_ => this.page.waitFor(1000))\n      .then(_ => this.page.goto(`${url}:${this.port}`))\n      .then(_ => this.page.setViewport({width: 1550, height: 850}));\n  }\n\n  exposeFunction(name = 'testDriverDone') {\n    return new Promise(resolve => {\n      this.page.exposeFunction(name, resolve);\n    });\n  }\n\n  stopBrowser() {\n    return Promise.resolve()\n      .then(_ => this.page.waitFor(1000))\n      .then(_ => this.browser.close());\n  }\n\n  startServer(config = {}, maxRetryTimes = 30) {\n    const newConfig = Object.assign({}, DEFAULT_CONFIG, config);\n    return new Promise((resolve, reject) => {\n      log.log({\n        message: `Binding to port: ${newConfig.port}`,\n        color: COLOR.YELLOW\n      })();\n      const timeout = setTimeout(() => { // eslint-disable-line\n        resolve();\n      }, 2000);\n      this.child = this.execFile(\n        newConfig.process,\n        [...newConfig.parameters, '--port', `${newConfig.port}`],\n        newConfig.options,\n        error => {\n          if (error) {\n            clearTimeout(timeout); // eslint-disable-line\n            log.log({\n              message: `Failed to bind port: ${newConfig.port}`,\n              color: COLOR.YELLOW\n            })();\n            reject(error);\n          }\n        }\n      );\n    })\n      .then(() => {\n        this.port = newConfig.port;\n      })\n      .catch(error => {\n        if (maxRetryTimes > 0) {\n          newConfig.port++;\n          return this.startServer(newConfig, maxRetryTimes - 1);\n        } else { // eslint-disable-line\n          log.log({\n            message: 'Failed to start server, use \\'killall node\\' to stop existing services',\n            color: COLOR.RED\n          })();\n          throw error;\n        }\n      });\n  }\n\n  stopServer() {\n    if (this.child) {\n      this.child.kill();\n      this.child = null;\n    }\n  }\n\n  exitProcess() {\n    // generate a return value that is visible to the shell, 0 is success\n    this.process.exit(this.shellStatus);\n  }\n\n  exit() {\n    return Promise.resolve()\n      .then(() => this.stopBrowser())\n      .then(() => {\n        this.stopServer();\n        this.exitProcess();\n      });\n  }\n}\n"],"file":"browser-driver.js"}