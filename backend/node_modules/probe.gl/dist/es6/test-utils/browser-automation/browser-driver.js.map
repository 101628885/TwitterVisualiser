{"version":3,"sources":["../../../../src/test-utils/browser-automation/browser-driver.js"],"names":["COLOR","Log","log","id","DEFAULT_CONFIG","process","parameters","port","options","maxBuffer","DEFAULT_PUPPETEER_OPTIONS","headless","BrowserDriver","constructor","execFile","module","require","puppeteer","console","child","browser","page","shellStatus","setShellStatus","success","startBrowser","Promise","resolve","launch","then","newPage","url","width","height","message","color","YELLOW","_","waitFor","goto","setViewport","exposeFunction","name","stopBrowser","close","startServer","config","maxRetryTimes","newConfig","Object","assign","reject","timeout","setTimeout","error","clearTimeout","catch","RED","stopServer","kill","exitProcess","exit"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {COLOR} from '../../lib/utils/color';\nimport Log from '../../lib/log';\nconst log = new Log({id: 'render-test'});\n\nconst DEFAULT_CONFIG = {\n  process: './node_modules/.bin/webpack-dev-server',\n  parameters: ['--config', 'webpack.config.js'],\n  port: 5000,\n  options: {maxBuffer: 5000 * 1024}\n};\n\nconst DEFAULT_PUPPETEER_OPTIONS = {\n  headless: false\n};\n\nexport default class BrowserDriver {\n  constructor() {\n    this.execFile = module.require('child_process').execFile;\n    this.puppeteer = module.require('puppeteer');\n    this.console = module.require('console');\n    this.process = module.require('process');\n\n    this.child = null;\n    this.browser = null;\n    this.page = null;\n    this.port = null;\n    this.shellStatus = 0;\n  }\n\n  setShellStatus(success) {\n    // return value that is visible to the shell, 0 is success\n    this.shellStatus = success ? 0 : 1;\n  }\n\n  startBrowser(options = DEFAULT_PUPPETEER_OPTIONS) {\n    if (this.browser) {\n      return Promise.resolve(this.browser);\n    }\n    return this.puppeteer\n      .launch(options)\n      .then(browser => {\n        this.browser = browser;\n      });\n  }\n\n  newPage({url = 'http://localhost', width = 1550, height = 850} = {}) {\n    log.log({\n      message: `Connecting to port: ${this.port}`,\n      color: COLOR.YELLOW\n    })();\n    return this.startBrowser()\n      .then(_ => this.browser.newPage())\n      .then(page => {\n        this.page = page;\n      })\n      .then(_ => this.page.waitFor(1000))\n      .then(_ => this.page.goto(`${url}:${this.port}`))\n      .then(_ => this.page.setViewport({width: 1550, height: 850}));\n  }\n\n  exposeFunction(name = 'testDriverDone') {\n    return new Promise(resolve => {\n      this.page.exposeFunction(name, resolve);\n    });\n  }\n\n  stopBrowser() {\n    return Promise.resolve()\n      .then(_ => this.page.waitFor(1000))\n      .then(_ => this.browser.close());\n  }\n\n  startServer(config = {}, maxRetryTimes = 30) {\n    const newConfig = Object.assign({}, DEFAULT_CONFIG, config);\n    return new Promise((resolve, reject) => {\n      log.log({\n        message: `Binding to port: ${newConfig.port}`,\n        color: COLOR.YELLOW\n      })();\n      const timeout = setTimeout(() => { // eslint-disable-line\n        resolve();\n      }, 2000);\n      this.child = this.execFile(\n        newConfig.process,\n        [...newConfig.parameters, '--port', `${newConfig.port}`],\n        newConfig.options,\n        error => {\n          if (error) {\n            clearTimeout(timeout); // eslint-disable-line\n            log.log({\n              message: `Failed to bind port: ${newConfig.port}`,\n              color: COLOR.YELLOW\n            })();\n            reject(error);\n          }\n        }\n      );\n    })\n      .then(() => {\n        this.port = newConfig.port;\n      })\n      .catch(error => {\n        if (maxRetryTimes > 0) {\n          newConfig.port++;\n          return this.startServer(newConfig, maxRetryTimes - 1);\n        } else { // eslint-disable-line\n          log.log({\n            message: 'Failed to start server, use \\'killall node\\' to stop existing services',\n            color: COLOR.RED\n          })();\n          throw error;\n        }\n      });\n  }\n\n  stopServer() {\n    if (this.child) {\n      this.child.kill();\n      this.child = null;\n    }\n  }\n\n  exitProcess() {\n    // generate a return value that is visible to the shell, 0 is success\n    this.process.exit(this.shellStatus);\n  }\n\n  exit() {\n    return Promise.resolve()\n      .then(() => this.stopBrowser())\n      .then(() => {\n        this.stopServer();\n        this.exitProcess();\n      });\n  }\n}\n"],"file":"browser-driver.js"}